<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">js/obj/MtlParser.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
</head>
<body class="layout-container">

<header>
  <a href="./">Home</a>
  <a href="identifiers.html">Identifier</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="git+https://github.com/magicien/DH3DLibrary.git">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div data-ice="classWrap">
  <h2>Class</h2>
  <ul>
    
  <li data-ice="classDoc"><span><a href="class/js/util/AjaxRequest.js~AjaxRequest.html">AjaxRequest</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Animator.js~Animator.html">Animator</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/util/BinaryReader.js~BinaryReader.html">BinaryReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/util/BinaryRequest.js~BinaryRequest.html">BinaryRequest</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Bone.js~Bone.html">Bone</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Camera.js~Camera.html">Camera</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/CameraAnimator.js~CameraAnimator.html">CameraAnimator</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/CameraKeyFrame.js~CameraKeyFrame.html">CameraKeyFrame</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/CameraMotion.js~CameraMotion.html">CameraMotion</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/CameraMotionBank.js~CameraMotionBank.html">CameraMotionBank</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/CameraMotionReader.js~CameraMotionReader.html">CameraMotionReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/CanvasField.js~CanvasField.html">CanvasField</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Constraint.js~Constraint.html">Constraint</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/DH2DObject.js~DH2DObject.html">DH2DObject</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/DH3DObject.js~DH3DObject.html">DH3DObject</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/DHAudio.js~DHAudio.html">DHAudio</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/DHEvent.js~DHEvent.html">DHEvent</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/Face.js~Face.html">Face</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/FaceMotion.js~FaceMotion.html">FaceMotion</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/FaceVertex.js~FaceVertex.html">FaceVertex</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/FragmentShader.js~FragmentShader.html">FragmentShader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/FrameBuffer.js~FrameBuffer.html">FrameBuffer</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/IK.js~IK.html">IK</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/IKFrame.js~IKFrame.html">IKFrame</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/KeyFrame.js~KeyFrame.html">KeyFrame</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/KeyListener.js~KeyListener.html">KeyListener</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Light.js~Light.html">Light</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/LightKeyFrame.js~LightKeyFrame.html">LightKeyFrame</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/MMDAnimator.js~MMDAnimator.html">MMDAnimator</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/MMDCameraAnimator.js~MMDCameraAnimator.html">MMDCameraAnimator</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Material.js~Material.html">Material</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Matrix.js~Matrix.html">Matrix</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/MessageWindow.js~MessageWindow.html">MessageWindow</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Model.js~Model.html">Model</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/ModelBank.js~ModelBank.html">ModelBank</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/ModelReader.js~ModelReader.html">ModelReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Motion.js~Motion.html">Motion</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/MotionBank.js~MotionBank.html">MotionBank</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/MotionReader.js~MotionReader.html">MotionReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/obj/MtlParser.js~MtlParser.html">MtlParser</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/obj/ObjMaterial.js~ObjMaterial.html">ObjMaterial</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/obj/ObjModel.js~ObjModel.html">ObjModel</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/obj/ObjParser.js~ObjParser.html">ObjParser</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/obj/ObjReader.js~ObjReader.html">ObjReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/ObjectLoadMonitor.js~ObjectLoadMonitor.html">ObjectLoadMonitor</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/PMDModel.js~PMDModel.html">PMDModel</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/PMDReader.js~PMDReader.html">PMDReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/RenderGroup.js~RenderGroup.html">RenderGroup</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Renderer.js~Renderer.html">Renderer</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/RigidBody.js~RigidBody.html">RigidBody</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/ShaderBank.js~ShaderBank.html">ShaderBank</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/ShadowKeyFrame.js~ShadowKeyFrame.html">ShadowKeyFrame</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/renderer/simple/SimpleFragmentShader.js~SimpleFragmentShader.html">SimpleFragmentShader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/renderer/simple/SimpleRenderer.js~SimpleRenderer.html">SimpleRenderer</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/renderer/simple/SimpleVertexShader.js~SimpleVertexShader.html">SimpleVertexShader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Skin.js~Skin.html">Skin</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/util/TextReader.js~TextReader.html">TextReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/util/TextRequest.js~TextRequest.html">TextRequest</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/TextureBank.js~TextureBank.html">TextureBank</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/TextureUV.js~TextureUV.html">TextureUV</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/renderer/toon/ToonFragmentShader.js~ToonFragmentShader.html">ToonFragmentShader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/renderer/toon/ToonRenderer.js~ToonRenderer.html">ToonRenderer</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/renderer/toon/ToonVertexShader.js~ToonVertexShader.html">ToonVertexShader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/VMDCameraMotion.js~VMDCameraMotion.html">VMDCameraMotion</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/VMDCameraReader.js~VMDCameraReader.html">VMDCameraReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/VMDMotion.js~VMDMotion.html">VMDMotion</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/mmd/VMDReader.js~VMDReader.html">VMDReader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Vector3.js~Vector3.html">Vector3</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/Vector4.js~Vector4.html">Vector4</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/base/VertexShader.js~VertexShader.html">VertexShader</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/xfile/XModel.js~XModel.html">XModel</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/xfile/XParser.js~XParser.html">XParser</a></span></li>
<li data-ice="classDoc"><span><a href="class/js/xfile/XReader.js~XReader.html">XReader</a></span></li>
</ul>
</div>



<div data-ice="functionWrap">
  <h2><a href="function/">Function</a></h2>
  <ul>
    
  <li data-ice="functionDoc"><span><a href="function/index.html#static-function-BinaryParser">BinaryParser</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeEUCJP">EscapeEUCJP</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeJIS7">EscapeJIS7</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeJIS8">EscapeJIS8</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeSJIS">EscapeSJIS</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeUTF16LE">EscapeUTF16LE</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeUTF7">EscapeUTF7</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeUTF8">EscapeUTF8</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-EscapeUnicode">EscapeUnicode</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-GetEscapeCodeType">GetEscapeCodeType</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-ObjectAssign">ObjectAssign</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeEUCJP">UnescapeEUCJP</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeJIS7">UnescapeJIS7</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeJIS8">UnescapeJIS8</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeSJIS">UnescapeSJIS</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeUTF16LE">UnescapeUTF16LE</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeUTF7">UnescapeUTF7</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeUTF8">UnescapeUTF8</a></span></li>
<li data-ice="functionDoc"><span><a href="function/index.html#static-function-UnescapeUnicode">UnescapeUnicode</a></span></li>
</ul>
</div>

<div data-ice="variableWrap">
  <h2><a href="variable/">Variable</a></h2>
  <ul>
    
  <li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-JCT11280">JCT11280</a></span></li>
<li data-ice="variableDoc"><span><a href="variable/index.html#static-variable-JCT8836">JCT8836</a></span></li>
</ul>
</div>




</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/obj/MtlParser.js</h1>
<pre class="source-code line-number"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

import Bone from &apos;../base/Bone&apos;
import Vector3 from &apos;../base/Vector3&apos;
import Vector4 from &apos;../base/Vector4&apos;
import Material from &apos;../base/Material&apos;
import ObjModel from &apos;./ObjModel&apos;
import RenderGroup from &apos;../base/RenderGroup&apos;
import Skin from &apos;../base/Skin&apos;
import TextureUV from &apos;../base/TextureUV&apos;

/**
 * MtlParser class
 * @access public
 */
export default class MtlParser {
  /**
   * constructor
   * @access public
   * @constructor
   */
  constructor() {
    this._data = null
    this._lines = null

    this._obj = null
    this._parentDirName = null
    this._indices = null
    //this._materialIndex = 0
    this._skinArray = null
    //this._normalIndex = 0
    this._faceNormalArray = null
    this._breakFlag = false

    this._offset = 0
    this._err = 0

    this._defaultGroupName = &apos;default&apos;
    this._smoothingGroup = 0
    this._smoothingVertices = null

    this._parentDirName = &apos;./&apos;

    this._normalArray = []
    this._textureUVArray = []
    this._groupName = this._defaultGroupName
    this._smoothingVerticesHash = new Map()
  }

  setParentDirName(dirName) {
    this._parentDirName = dirName
  }

  setModel(obj) {
    this._obj = obj
  }

  setData(data) {
    this._data = data.replace(/( )*\\( )*\n/g, &apos; &apos;)
    this._lines = this._data.split(&apos;\n&apos;)
  }

  // FIXME: parse method is unused.
  parse(data){
    console.log(&apos;ObjParser.parse start&apos;)
    if(data){
      this.setData(data)
    }
    if(!this._obj){
      this._obj = new ObjModel()
    }
    if(!this._obj.skinArray){
      this._obj.skinArray = []
      this._obj.dynamicSkinOffset = -1
    }
    this._skinArray = this._obj.skinArray

    this._offset = 0
    this._err = 0

    const result = this.process()
    /*
    if(this._err){
      alert(&apos;obj format error:&apos; + this._err)
      return null
    }
    this.splitFaceNormals()
    */

    console.log(&apos;ObjParser.parse end&apos;)
    return result
  }

  process() {
    console.log(&apos;ObjParser.process start&apos;)
    let line = &apos;&apos;
    this._breakFlag = false

    //let v_count = 0
    //let f_count = 0
    let mtllib_name = &apos;&apos;

    const dummy_normal = new Vector3()
    const dummy_uv = new TextureUV()

    while(!this._breakFlag &amp;&amp; (line = this.readLine()) != null){
      const tokens = this.getTokens(line)

      if(tokens.length === 0){
        continue
      }

      switch(tokens[0]){
        case &apos;#&apos;: // comment
          continue

        case &apos;v&apos;: // geometric vertices
          const skin = new Skin()
          const pos = new Vector3()

          pos.x = parseFloat(tokens[1])
          pos.y = parseFloat(tokens[2])
          pos.z = parseFloat(tokens[3])
          skin.position = pos

          skin.boneIndex[0] = 0
          skin.boneIndex[1] = -1
          skin.boneIndex[2] = -1
          skin.boneIndex[3] = -1

          skin.skinWeight[0] = 1
          skin.skinWeight[1] = 0
          skin.skinWeight[2] = 0
          skin.skinWeight[3] = 0

          // FIXME: delete following 2 lines
          //skin.normal = dummy_normal
          //skin.textureUV = dummy_uv
          skin.normal = null
          skin.textureUV = null

          skin._smoothingGroup = -1

          this._skinArray.push(skin)
          //v_count++
          break

        case &apos;vt&apos;: // texture vertices
          const uv = new TextureUV()
          uv.u = parseFloat(tokens[1])
          uv.v = parseFloat(tokens[2])
          this._textureUVArray.push(uv)
          break

        case &apos;vn&apos;: // vertex normals
          const n = new Vector3()
          n.x = parseFloat(tokens[1])
          n.y = parseFloat(tokens[2])
          n.z = parseFloat(tokens[3])
          this._normalArray.push(n)
          break

        case &apos;vp&apos;: // parameter space vertices
          break
        case &apos;deg&apos;: // degree
          break
        case &apos;bmat&apos;: // basis matrix
          break
        case &apos;step&apos;: // step size
          break
        case &apos;cstype&apos;: // curve or surface type
          break
        case &apos;p&apos;: // point
          break
        case &apos;l&apos;: // line
          break
        case &apos;f&apos;: // face
          const num_faces = tokens.length - 4
          for(let i=0; i&lt;num_faces; i++){
            const data1 = tokens[i+0].split(&apos;/&apos;) 
            const data2 = tokens[i+1].split(&apos;/&apos;)
            const data3 = tokens[i+2].split(&apos;/&apos;)

            const nv1 = data1[0]; const nt1 = data1[1]; const nn1 = data1[2]
            const nv2 = data2[0]; const nt2 = data2[1]; const nn2 = data2[2]
            const nv3 = data3[0]; const nt3 = data3[1]; const nn3 = data2[2]

            if(nv1 === &apos;&apos; || nv2 === &apos;&apos; || nv3 === &apos;&apos;){
              // error
              console.log(&apos;format error: f: vertex index&apos;)
              return null
            }

            let v1 = this._skinArray[nv1 - 1]
            if(v1._smoothingGroup === -1){
              // new

              v1._smoothingGroup = this._smoothingGroup
              if(nt1){
                v1.textureUV = this._textureUVArray[nt1 - 1]
              }else{
                v1.textureUV = null
              }

              if(nn1){
                v1.normal = this._normalArray[nn1 - 1]
              }else{
                v1.normal = null
              }
            }else if(v1._smoothingGroup === this._smoothingGroup){
              // same group

              let checkFace = null
              for(checkFace = v1; checkFace; checkFace = checkFace._next){
                // check 
                // check texture
                if(nt1){
                  if(checkFace.texture !== this._textureUVArray[nt1 - 1]){
                    continue
                  }
                }else{
                  if(checkFace.texture){
                    continue
                  }
                }
                // check normal
                if(nn1){
                  if(checkFace.normal !== this._normalArray[nn1 - 1]){
                    continue
                  }
                }else{
                  if(checkFace.normal){
                    continue
                  }
                }
                break
              }
              if(checkFace){
                v1 = checkFace
              }else{
                // create skin
              }
            }else{
              // different group
            }

            const v2 = this._skinArray[nv2 - 1]
            const v3 = this._skinArray[nv3 - 1]


          }
          break

        case &apos;curv&apos;: // curve
          break
        case &apos;curv2&apos;: // 2D curve
          break
        case &apos;surf&apos;: // surface
          break
        case &apos;parm&apos;: // parameter values
          break
        case &apos;trim&apos;: // outer trimming loop
          break
        case &apos;hole&apos;: // inner trimming loop
          break
        case &apos;scrv&apos;: // special curve
          break
        case &apos;sp&apos;: // special point
          break
        case &apos;end&apos;: // end statement
          break
        case &apos;con&apos;: // connect
          break
        case &apos;g&apos;: // group name
          if(tokens[1] === &apos;&apos;){
            this._groupName = this._defaultGroupName
          }else{
            this._groupName = tokens[1]
          }
          break

        case &apos;s&apos;: // smoothing group
          if(tokens[1] === &apos;off&apos; || tokens[1] &lt;= 0){
            this._smoothingGroup = 0
            this._smoothingVertices = null
          }else{
            this._smoothingGroup = tokens[1]
            this._smoothingVertices = this._smoothingVerticesHash.get(this._smoothingGroup)
            if(!this._smoothingVertices){
              this._smoothingVertices = []
              this._smoothingVerticesHash.set(this._smoothingGroup, this._smoothingVertices)
            }
          }
          break

        case &apos;mg&apos;: // merging group
          break
        case &apos;o&apos;: // object name
          break
        case &apos;bevel&apos;: // bevel interpolation
          break
        case &apos;c_interp&apos;: // color interpolation
          break
        case &apos;d_interp&apos;: // dissolve interpolation
          break
        case &apos;lod&apos;: // level of detail
          break
        case &apos;usemtl&apos;: // material name
          break
        case &apos;mtllib&apos;: // material library
          mtllib_name = tokens[1]
          console.log(&apos;mtllib: &apos; + mtllib_name)

          // FIXME: MTLReader
          const baseBone = new Bone()
          const renderGroupArray = []
          const renderGroupHash = {}

          const group = new RenderGroup()
          group.boneArray = []
          group.boneArray[0] = baseBone
          renderGroupArray.push(group)

          this._obj.renderGroupArray = renderGroupArray
          this._obj.boneArray.push(baseBone)
          this._obj.rootBone.addChild(baseBone)

          const material = new Material()
          material.ambient = new Vector4()
          material.diffuse = new Vector4()
          material.shininess = 1.0
          material.specular = new Vector3()
          material.emission = new Vector3()
          material.edge = 0
          material.texture = null

          this._obj.materialArray.push(material)
          this._obj.renderGroupArray[0].material = material

          break
        case &apos;shadow_obj&apos;: // shadow casting
          break
        case &apos;trace_obj&apos;: // ray tracing
          break
        case &apos;ctech&apos;: // curve approximation technique
          break
        case &apos;stech&apos;: // surface approximation technique
          break
        default: // unknwon type
          break
      }
    }

    if(this._breakFlag){
      return false
    }

    //console.log(&apos;v: &apos; + v_count + &apos;\nf: &apos; + f_count + &apos;\nmtllib: &apos; + mtllib_name)

    if(this._err){
      console.log(&apos;obj format error:&apos; + this._err)
      return null
    }
    //this.splitFaceNormals()
    console.log(&apos;ObjParser.process end&apos;)
    return true
  }

  readLine() {
    return this._lines.shift()
  }

  getTokens(line) {
    //return line.split(&apos; &apos;).without(&apos;&apos;)
    return line.split(&apos; &apos;).filter((str) =&gt; { return str !== &apos;&apos; })
  }

/*
  moveIndex(len) {
    this._text = this._text.substring(len)
    this._offset += len
  }
*/

/*
  skip() {
    const str = this._text.match(this._skipPattern)
    if(str != null){
      const len = str[0].length
      this.moveIndex(len)
    }
  }
*/

/*
  getString(pattern) {
    this.skip()
    const str = this._text.match(pattern)
    if(str != null){
      this.moveIndex(str[0].length)
      return str[0]
    }
    return null
  }
*/

  /* matching patterns */
  /*
  _skipPattern: new RegExp(/^\s+/),
  skip() {
    const i=0
    const code
    while(1){
      code = this._text.charCodeAt(i)
      if(code != 32 &amp;&amp; (code &lt; 9 || code &gt; 13)){
        break
      }
      i++
    }
    if(i&gt;0){
      this.moveIndex(i)
    }
  }
  */

/*
  _integerPattern: new RegExp(/^(-|\+)?\d+?/),
  getInteger() {
    const str = this.getString(this._integerPattern)
    const val = parseInt(str)
    return val
  }

  _floatPattern: new RegExp(/^(-|\+)?(\d)*\.(\d)*?/),
  getFloat() {
    const str = this.getString(this._floatPattern)
    const val = parseFloat(str)
    return val
  }

  _commaOrSemicolonPattern: new RegExp(/^,|/),
  getCommaOrSemicolon() {
    const code = this._text.charCodeAt(0)
    if(code == 44 || code == 59){
      this.moveIndex(1)
    }
  }
    
  _wordPattern: new RegExp(/^\w+/),
  getWord() {
    return this.getString(this._wordPattern)
  }

  _uuidPattern: new RegExp(/^&lt;[\w-]+&gt;/),
  getUUID() {
    return this.getString(this._uuidPattern)
  }

  _leftBracePattern: new RegExp(/^{/),
  getLeftBrace() {
    return this.getString(this._leftBracePattern)
  }

  _rightBracePattern: new RegExp(/^}/),
  getRightBrace() {
    return this.getString(this._rightBracePattern)
  }

  _memberPattern: new RegExp(/^((array\s+\w+\s+\w+\[(\d+|\w+)\]|\w+\s+\w+)\s*|\[[\w.]+\])/),
  getMember() {
    return this.getString(this._memberPattern)
  }

  _filenamePattern: new RegExp(/^&apos;(.*)&apos;?/),
  getFilename() {
    const str = this.getString(this._filenamePattern)
    return RegExp.$1
  }

  getIntegerArray() {
    const n = this.getInteger()
    const arr = []
    for(var i=0 i&lt;n i++){
      arr.push(this.getInteger())
      this.getCommaOrSemicolon()
    }
    return arr
  }

  getFloatArray() {
    const n = this.getInteger()
    const arr = []
    for(var i=0 i&lt;n i++){
      arr.push(this.getInteger())
      this.getCommaOrSemicolon()
    }
    return arr
  }

  getVector3() {
    const v = new Vector3()
    v.x = this.getFloat()
    v.y = this.getFloat()
    v.z = this.getFloat()
    this.getCommaOrSemicolon()

    return v
  }

  getVector4() {
    const v = new Vector4()
    v.x = this.getFloat()
    v.y = this.getFloat()
    v.z = this.getFloat()
    v.w = this.getFloat()
    this.getCommaOrSemicolon()

    return v
  }

  // X&#x30D5;&#x30A1;&#x30A4;&#x30EB;&#x8AAD;&#x307F;&#x8FBC;&#x307F;&#x5F8C;&#x306B;&#x9802;&#x70B9;&#x3092;&#x30B3;&#x30D4;&#x30FC;
  splitFaceNormals(){
    const v = this._faceNormalArray
    const vnMap = []
    const normals = []
    const skins = this._obj.skinArray
    const vertexCount = skins.length

    // textureCoords&#x306E;&#x8A2D;&#x5B9A;
    if(skins[0].textureUV == null){
      for(var i=0 i&lt;vertexCount i++){
        skins[i].textureUV = new TextureUV()
      }
    }

    // &#x6CD5;&#x7DDA;&#x306E;&#x8A2D;&#x5B9A;
    if(this._faceNormalArray == null){
      // &#x6CD5;&#x7DDA;&#x304C;&#x6307;&#x5B9A;&#x3055;&#x308C;&#x3066;&#x3044;&#x306A;&#x3044;&#x5834;&#x5408;&#x3001;&#x81EA;&#x5206;&#x3067;&#x8A08;&#x7B97;&#x3059;&#x308B;&#x3002;
      const ins = this._indices
      const numIns = ins.length
      const used = []

      const n
      const n1 = new Vector3()
      const n2 = new Vector3()

      for(var i=0 i&lt;numIns i++){
        if(ins[i].length == 4){
          // &#x56DB;&#x89D2;&#x5F62;
          const ii = ins[i]
          const s = skins[ii[0]]
          n = new Vector3()
          if(used[ii[0]]){
            s = Object.clone(s)
            skins[skins.length] = s
          }
          used[ii[0]] = true
          n1.sub(skins[ii[2]].position, skins[ii[0]].position)
          n2.sub(skins[ii[1]].position, skins[ii[0]].position)
          n.cross(n1, n2)
          n.normalize()
          s.normal = n

          n = new Vector3()
          s = skins[ii[1]]
          if(used[ii[1]]){
            s = Object.clone(s)
            skins[skins.length] = s
          }
          used[ii[1]] = true
          n1.sub(skins[ii[0]].position, skins[ii[1]].position)
          n2.sub(skins[ii[2]].position, skins[ii[1]].position)
          n.cross(n1, n2)
          n.normalize()
          s.normal = n

          n = new Vector3()
          s = skins[ii[2]]
          if(used[ii[2]]){
            s = Object.clone(s)
            skins[skins.length] = s
          }
          used[ii[2]] = true
          n1.sub(skins[ii[1]].position, skins[ii[2]].position)
          n2.sub(skins[ii[0]].position, skins[ii[2]].position)
          n.cross(n1, n2)
          n.normalize()
          s.normal = n

          n = new Vector3()
          s = skins[ii[3]]
          if(used[ii[3]]){
            s = Object.clone(s)
            skins[skins.length] = s
          }
          if(!(skins[ii[3]] instanceof Object)){
            alert(&apos;skins[ii[3]] not instance!&apos;)
            alert(&apos;i: &apos; + i + &apos;, ii[3]: &apos; + ii[3])
          }
          used[ii[3]] = true
          n1.sub(skins[ii[2]].position, skins[ii[3]].position)
          n2.sub(skins[ii[0]].position, skins[ii[3]].position)
          n.cross(n1, n2)
          n.normalize()
          s.normal = n
        }else if(ins[i].length == 3){
          // &#x4E09;&#x89D2;&#x5F62;
          const ii = ins[i]
          const s = skins[ii[0]]
          n = new Vector3()
          if(used[ii[0]]){
            s = Object.clone(s)
            skins[skins.length] = s
          }
          used[ii[0]] = true
          n1.sub(skins[ii[2]].position, skins[ii[0]].position)
          n2.sub(skins[ii[1]].position, skins[ii[0]].position)
          n.cross(n1, n2)
          n.normalize()
          s.normal = n

          n = new Vector3()
          s = skins[ii[1]]
          if(used[ii[1]]){
            s = Object.clone(s)
            skins[skins.length] = s
          }
          used[ii[1]] = true
          n1.sub(skins[ii[0]].position, skins[ii[1]].position)
          n2.sub(skins[ii[2]].position, skins[ii[1]].position)
          n.cross(n1, n2)
          n.normalize()
          s.normal = n

          n = new Vector3()
          s = skins[ii[2]]
          if(used[ii[2]]){
            s = Object.clone(s)
            skins[skins.length] = s
          }
          used[ii[2]] = true
          n1.sub(skins[ii[1]].position, skins[ii[2]].position)
          n2.sub(skins[ii[0]].position, skins[ii[2]].position)
          n.cross(n1, n2)
          n.normalize()
          s.normal = n


        }else{
          // &#x672A;&#x5BFE;&#x5FDC;
        }
      }
    }else{
      // &#x540C;&#x3058;&#x9802;&#x70B9;&#x306B;&#x9055;&#x3046;&#x6CD5;&#x7DDA;&#x304C;&#x6307;&#x5B9A;&#x3055;&#x308C;&#x3066;&#x3044;&#x308B;&#x5834;&#x5408;&#x3001;&#x5225;&#x9802;&#x70B9;&#x3068;&#x3059;&#x308B;&#x3002;
      for(var i=0 i&lt;vertexCount i++){
        vnMap[i] = {}
        normals[i] = -1
      }

      const vSize = v.length
      const ins = this._indices
      for(var i=0 i&lt;vSize i++){
        const vi = v[i]
        const ii = ins[i]
        for(var j=0 j&lt;vi.length j++){
          if(normals[ii[j]] == -1){
            // &#x672A;&#x767B;&#x9332;
            normals[ii[j]] = vi[j]
            vnMap[ii[j]].set(vi[j], ii[j])
          }else if(normals[ii[j]] == vi[j]){
            // &#x767B;&#x9332;&#x6E08;&#x307F;
          }else{
            const newNo = vnMap[ii[j]].get(vi[j])
            if(newNo == null){
              // &#x672A;&#x767B;&#x9332;
              newNo = vnMap.length
              vnMap[ii[j]].set(vi[j], newNo)
              normals[newNo] = vi[j]
              //this._obj.skinArray[newNo] = this._obj.skinArray[ii[j]].clone()
              this._obj.skinArray[newNo] = Object.clone(this._obj.skinArray[ii[j]])
            }else{
              // &#x767B;&#x9332;&#x6E08;&#x307F;
            }
          }
        }
      }

      for(var i=0 i&lt;normals.length i++){
        this._obj.skinArray[i].normal = this._normalArray[normals[i]]
      }
    }
  }

  XFileHeader(parent){
    const text = this._text
    if(!text.match(/^xof (\d\d\d\d)([ \w][ \w][ \w][ \w])(\d\d\d\d)/)){
      return false
    }
    this.moveIndex(16)

    this.version = RegExp.$1
    this.format = RegExp.$2
    this.floatSize = RegExp.$3
    return true
  }

  XObjectLong(parent){
    const id = this.getWord()
    if(id == null){
      return null
    }
    switch(id){
      case &apos;template&apos;:
        return this.Template(parent)
      case &apos;Header&apos;:
        return this.Header(parent)
      case &apos;Mesh&apos;:
        return this.Mesh(parent)
      case &apos;MeshMaterialList&apos;:
        return this.MeshMaterialList(parent)
      case &apos;MeshNormals&apos;:
        return this.MeshNormals(parent)
      case &apos;MeshTextureCoords&apos;:
        return this.MeshTextureCoords(parent)
      case &apos;MeshVertexColors&apos;:
        return this.MeshVertexColors(parent)

      default:
        alert(&apos;unknown type:&apos; + id)
        break
    }
    return false
  }

  ColorRGB(parent) {
    const color = new Vector4()
    color.x = this.getFloat()
    color.y = this.getFloat()
    color.z = this.getFloat()
    color.w = 1.0
    this.getCommaOrSemicolon()

    return color
  }

  ColorRGBA(parent) {
    const color = new Vector4()
    color.x = this.getFloat()
    color.y = this.getFloat()
    color.z = this.getFloat()
    color.w = this.getFloat()
    this.getCommaOrSemicolon()

    return color
  }

  Coords2d(parent) {
    const v = new TextureUV()
    v.u = this.getFloat()
    v.v = this.getFloat()
    this.getCommaOrSemicolon()

    return v
  }

  Template(parent) {
    const name = this.getWord()
    this.getLeftBrace()
    const uuid = this.getUUID()
    do{
      const member = this.getMember()
    }while(member != null)
    this.getRightBrace()
    return true
  }

  Header(parent) {
    this.getLeftBrace()
    const major = this.getInteger()
    const minor = this.getInteger()
    const flags = this.getInteger()
    this.getRightBrace()
    return true
  }

  IndexedColor(parent) {
    const index = this.getInteger()
    const color = this.ColorRGBA()
    color.index = index

    return color
  }

  Material(parent) {
    this.getLeftBrace()
    const material = new Material()

    material.ambient = this.ColorRGBA()
    material.diffuse = material.ambient
    material.shininess = this.getFloat()
    material.specular = this.ColorRGB()
    material.emission = this.ColorRGB()
    material.edge = 0
    material.texture = null

    const name = this.getWord()
    if(name == &apos;TextureFilename&apos;){
      const texture = this.TextureFilename()
      if(texture != null){
        material.texture = texture
        //material.textureFileName = texture.fileName
      }
    }

    this.getRightBrace()

    return material
  }

  Mesh(parent) {
    this.getLeftBrace()

    // vertices
    const nVertices = this.getInteger()
    const skinArray = []
    for(var i=0 i&lt;nVertices i++){
      const skin = new Skin()
      const pos = new Vector3()
      pos.x = this.getFloat()
      pos.y = this.getFloat()
      pos.z = -this.getFloat()
      skin.position = pos

      skin.boneIndex[0] = 0
      skin.boneIndex[1] = -1
      skin.boneIndex[2] = -1
      skin.boneIndex[3] = -1

      skin.skinWeight[0] = 1
      skin.skinWeight[1] = 0
      skin.skinWeight[2] = 0
      skin.skinWeight[3] = 0

      skinArray.push(skin)

      this.getCommaOrSemicolon()
    }
    this._obj.skinArray = skinArray
    this._obj.dynamicSkinOffset = -1

    // faces
    const nFaces = this.getInteger()
    const faces = []
    for(var i=0 i&lt;nFaces i++){
      const face = this.getIntegerArray()
      faces.push(face)
    }
    this._indices = faces
    this.getRightBrace()

    return true
  }

  MeshMaterialList(parent) {
    this.getLeftBrace()

    // materials
    const nMaterials = this.getInteger()
    this._materialIndex = 0

    const baseBone = new Bone()
    const renderGroups = []
    for(var i=0 i&lt;nMaterials i++){
      const group = new RenderGroup()
      group.boneArray = []
      group.boneArray[0] = baseBone

      renderGroups.push(group)
    }
    this._obj.renderGroupArray = renderGroups
    this._obj.boneArray.push(baseBone)
    this._obj.rootBone.addChild(baseBone)

    // face materials
    const nFaceIndices = this.getInteger()
    const indices = this._indices
    for(var i=0 i&lt;nFaceIndices i++){
      const index = this.getInteger()
      this.getCommaOrSemicolon()

      const gind = renderGroups[index].indices
      const ind = indices[i]

      if(ind.length == 3){
        gind.push(ind[0])
        gind.push(ind[2])
        gind.push(ind[1])
      }else if(indices[i].length == 4){
        gind.push(ind[0])
        gind.push(ind[2])
        gind.push(ind[1])
        gind.push(ind[0])
        gind.push(ind[3])
        gind.push(ind[2])
      }else{
        // FIXME: &#x672A;&#x5BFE;&#x5FDC;
      }
    }

    // materials
    const material = null
    while(1){
      const name = this.getWord()
      if(name == &apos;Material&apos;){
        material = this.Material(parent)

        this._obj.materialArray.push(material)
        this._obj.renderGroupArray[this._materialIndex].material = material
        this._materialIndex++
      }else{
        break
      }
    }
        
    this.getRightBrace()

    return true
  }

  MeshNormals(parent) {
    this.getLeftBrace()
    const nNormals = this.getInteger()
    
    this._normalArray = []
    for(var i=0 i&lt;nNormals i++){
      const v = this.getVector3()
      v.z = -v.z
      this._normalArray.push(v)
    }

    const nFaceNormals = this.getInteger()
    this._faceNormalArray = []
    for(var i=0 i&lt;nFaceNormals i++){
      const v = this.getIntegerArray()
      this._faceNormalArray.push(v)
    }

    this.getRightBrace()

    return true
  }

  MeshTextureCoords(parent) {
    this.getLeftBrace()

    const skins = this._obj.skinArray
    const nTextureCoords = this.getInteger()
    for(var i=0 i&lt;nTextureCoords i++){
      skins[i].textureUV = this.Coords2d()
    }

    this.getRightBrace()

    return true
  }

  MeshVertexColors(parent) {
    this.getLeftBrace()

    const nVertexColors = this.getInteger()
    for(var i=0 i&lt;nVertexColors i++){
      const v = this.IndexedColor()
      // FIXME: not implemented.
    }

    this.getRightBrace()

    return true
  }

  TextureFilename(parent) {
    this.getLeftBrace()
    const name = this.getFilename()
    name = name.replace(&apos;\\\\&apos;, &apos;/&apos;)
    this.getRightBrace()

    const texture = TextureBank.getTexture(this._parentDirName + name)

    return texture
  }
*/
}
</code></pre>
</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.2.1)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
