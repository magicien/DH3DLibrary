<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <base data-ice="baseUrl" href="../../../">
  <title data-ice="title">js/base/MessageWindow.js | API Document</title>
  <link type="text/css" rel="stylesheet" href="css/style.css">
  <link type="text/css" rel="stylesheet" href="css/prettify-tomorrow.css">
  <script src="script/prettify/prettify.js"></script>
  
  
  <script src="script/manual.js"></script>
</head>
<body class="layout-container" data-ice="rootContainer">

<header>
  <a href="./">Home</a>
  
  <a href="identifiers.html">Reference</a>
  <a href="source.html">Source</a>
  
  <a data-ice="repoURL" href="https://github.com/magicien/DH3DLibrary" class="repo-url-github">Repository</a>
  <div class="search-box">
  <span>
    <img src="./image/search.png">
    <span class="search-input-edge"></span><input class="search-input"><span class="search-input-edge"></span>
  </span>
    <ul class="search-result"></ul>
  </div>
</header>

<nav class="navigation" data-ice="nav"><div>
  <ul>
    
  <li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">base</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Animator.js~Animator.html">Animator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Bone.js~Bone.html">Bone</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Camera.js~Camera.html">Camera</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/CameraAnimator.js~CameraAnimator.html">CameraAnimator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/CameraKeyFrame.js~CameraKeyFrame.html">CameraKeyFrame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/CameraMotion.js~CameraMotion.html">CameraMotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/CameraMotionBank.js~CameraMotionBank.html">CameraMotionBank</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/CameraMotionReader.js~CameraMotionReader.html">CameraMotionReader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/CanvasField.js~CanvasField.html">CanvasField</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Constraint.js~Constraint.html">Constraint</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/DH2DObject.js~DH2DObject.html">DH2DObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/DH3DObject.js~DH3DObject.html">DH3DObject</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/DHAudio.js~DHAudio.html">DHAudio</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/DHEvent.js~DHEvent.html">DHEvent</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/FragmentShader.js~FragmentShader.html">FragmentShader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/IK.js~IK.html">IK</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/KeyFrame.js~KeyFrame.html">KeyFrame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/KeyListener.js~KeyListener.html">KeyListener</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Light.js~Light.html">Light</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/LightKeyFrame.js~LightKeyFrame.html">LightKeyFrame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Material.js~Material.html">Material</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Matrix.js~Matrix.html">Matrix</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/MessageWindow.js~MessageWindow.html">MessageWindow</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Model.js~Model.html">Model</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/ModelBank.js~ModelBank.html">ModelBank</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/ModelReader.js~ModelReader.html">ModelReader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Motion.js~Motion.html">Motion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/MotionBank.js~MotionBank.html">MotionBank</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/MotionReader.js~MotionReader.html">MotionReader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/ObjectLoadMonitor.js~ObjectLoadMonitor.html">ObjectLoadMonitor</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/RenderGroup.js~RenderGroup.html">RenderGroup</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Renderer.js~Renderer.html">Renderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/RigidBody.js~RigidBody.html">RigidBody</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/ShaderBank.js~ShaderBank.html">ShaderBank</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/ShadowKeyFrame.js~ShadowKeyFrame.html">ShadowKeyFrame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Skin.js~Skin.html">Skin</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/TextureBank.js~TextureBank.html">TextureBank</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/TextureUV.js~TextureUV.html">TextureUV</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Vector3.js~Vector3.html">Vector3</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/Vector4.js~Vector4.html">Vector4</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/base/VertexShader.js~VertexShader.html">VertexShader</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">etc</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-ObjectAssign">ObjectAssign</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">mmd</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/Face.js~Face.html">Face</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/FaceMotion.js~FaceMotion.html">FaceMotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/FaceVertex.js~FaceVertex.html">FaceVertex</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/IKFrame.js~IKFrame.html">IKFrame</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/MMDAnimator.js~MMDAnimator.html">MMDAnimator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/MMDCameraAnimator.js~MMDCameraAnimator.html">MMDCameraAnimator</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/PMDModel.js~PMDModel.html">PMDModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/PMDReader.js~PMDReader.html">PMDReader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/VMDCameraMotion.js~VMDCameraMotion.html">VMDCameraMotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/VMDCameraReader.js~VMDCameraReader.html">VMDCameraReader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/VMDMotion.js~VMDMotion.html">VMDMotion</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/mmd/VMDReader.js~VMDReader.html">VMDReader</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">obj</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/obj/MtlParser.js~MtlParser.html">MtlParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/obj/ObjMaterial.js~ObjMaterial.html">ObjMaterial</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/obj/ObjModel.js~ObjModel.html">ObjModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/obj/ObjParser.js~ObjParser.html">ObjParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/obj/ObjReader.js~ObjReader.html">ObjReader</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">renderer/simple</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/renderer/simple/SimpleFragmentShader.js~SimpleFragmentShader.html">SimpleFragmentShader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/renderer/simple/SimpleRenderer.js~SimpleRenderer.html">SimpleRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/renderer/simple/SimpleVertexShader.js~SimpleVertexShader.html">SimpleVertexShader</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">renderer/toon</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/renderer/toon/ToonFragmentShader.js~ToonFragmentShader.html">ToonFragmentShader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/renderer/toon/ToonRenderer.js~ToonRenderer.html">ToonRenderer</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/renderer/toon/ToonVertexShader.js~ToonVertexShader.html">ToonVertexShader</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">third_party</div><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-BinaryParser">BinaryParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeEUCJP">EscapeEUCJP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeJIS7">EscapeJIS7</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeJIS8">EscapeJIS8</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeSJIS">EscapeSJIS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeUTF16LE">EscapeUTF16LE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeUTF7">EscapeUTF7</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeUTF8">EscapeUTF8</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-EscapeUnicode">EscapeUnicode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-GetEscapeCodeType">GetEscapeCodeType</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeEUCJP">UnescapeEUCJP</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeJIS7">UnescapeJIS7</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeJIS8">UnescapeJIS8</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeSJIS">UnescapeSJIS</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeUTF16LE">UnescapeUTF16LE</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeUTF7">UnescapeUTF7</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeUTF8">UnescapeUTF8</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-function">F</span><span data-ice="name"><span><a href="function/index.html#static-function-UnescapeUnicode">UnescapeUnicode</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-JCT11280">JCT11280</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-variable">V</span><span data-ice="name"><span><a href="variable/index.html#static-variable-JCT8836">JCT8836</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">util</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/AjaxRequest.js~AjaxRequest.html">AjaxRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/BinaryReader.js~BinaryReader.html">BinaryReader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/BinaryRequest.js~BinaryRequest.html">BinaryRequest</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/TextReader.js~TextReader.html">TextReader</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/util/TextRequest.js~TextRequest.html">TextRequest</a></span></span></li>
<li data-ice="doc"><div data-ice="dirPath" class="nav-dir-path">xfile</div><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/xfile/XModel.js~XModel.html">XModel</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/xfile/XParser.js~XParser.html">XParser</a></span></span></li>
<li data-ice="doc"><span data-ice="kind" class="kind-class">C</span><span data-ice="name"><span><a href="class/js/xfile/XReader.js~XReader.html">XReader</a></span></span></li>
</ul>
</div>
</nav>

<div class="content" data-ice="content"><h1 data-ice="title">js/base/MessageWindow.js</h1>
<pre class="source-code line-number raw-source-code"><code class="prettyprint linenums" data-ice="content">&apos;use strict&apos;

import DH2DObject from &apos;./DH2DObject&apos;
import Vector3 from &apos;./Vector3&apos;

/**
 * MessageWindow class
 * @access public
 */
export default class MessageWindow extends DH2DObject {
  /**
   * constructor
   * @access public
   * @constructor
   */
  constructor() {
    super()

    this._bindedObject = null
    this._bindedCnavas = null
    this._bindedCamera = null
    this._bindedBone = null

    this._time = 0.0
    this._speed = 3.0

    this._mode = 0
    this._x = 100
    this._y = 140

    this._message = &apos;&apos;
    this._formattedMessage = []
    this._lines = 0
    this._lineHeight = 15
    this._messageWidth = 0
    this._messageHeight = 0
    this._messageNumChars = 0
    this._maxWidth = -1
    this._offset = null
    this._screenOffset = null
    this._margin = 5
    this._padding = 5
    this._iconPadding = 5

    this._icon = null

    // balloon context
    this._borderColor = &apos;black&apos;
    this._backgroundColor = &apos;white&apos;
    this._globalAlpha = 1
    this._globalCompositeOperation = &apos;source-over&apos;
    this._lineCap = &apos;butt&apos;
    this._lineJoin = &apos;miter&apos;
    this._lineWidth = 1
    this._miterLimit = 10
    this._balloonShadowBlur = 0
    this._balloonShadowColor = &apos;rgba(0, 0, 0, 0.0)&apos;
    this._balloonShadowOffsetX = 0
    this._balloonShadowOffsetY = 0

    // text context
    this._textColor = &apos;black&apos;
    this._font = &apos;10px sans-serif&apos;
    this._textAlign = &apos;start&apos;
    this._textBaseline = &apos;top&apos;
    this._textShadowBlur = 0
    this._textShadowColor = &apos;rgba(0, 0, 0, 0.0)&apos;
    this._textShadowOffsetX = 0
    this._textShadowOffsetY = 0
  }

  /**
   * animate message window
   * @access public
   * @param {float} elapsedTime - elapsed time (seconds) from previous frame
   * @returns {void}
   */
  animate(elapsedTime) {
    if(  this._mode === this.MODE_OPEN
      || this._mode === this.MODE_STRING
      || this._mode === this.MODE_CLOSE){
      this._time += this._speed * elapsedTime
    }
  }

  /**
   * render message window
   * @access public
   * @returns {void}
   */
  render() {
    //const c = this._bindedCanvas._2DContext
    const padding = this._padding
    const iconPadding = this._iconPadding
    const vHeight = 10
    const heightMax = this._messageHeight + padding * 2
    const widthMax = this._messageWidth + padding * 2
    let height = 0
    let width = 0

    let targetX = this._x
    let targetY = this._y
    if(this._bindedObject &amp;&amp; this._bindedCamera){
      const worldPos = new Vector3()

      if(this._bindedBone){ // FIXME
        const bone = this._bindedObject._model.boneHash[this._bindedBone]
        worldPos.x = bone.localMatrix.m41
        worldPos.y = bone.localMatrix.m42
        worldPos.z = bone.localMatrix.m43
      }else{
        worldPos.setValue(this._bindedObject._position)
      }

      if(this._offset){
        worldPos.add(worldPos, this._offset)
      }
      const windowPos = this._bindedCamera.getScreenPosition(worldPos)
      this._x = this._bindedCanvas._canvasWidth  * 0.5 * (1.0 + windowPos.x)
      this._y = this._bindedCanvas._canvasHeight * 0.5 * (1.0 - windowPos.y)

      if(this._screenOffset){
        this._x += this._screenOffset.x
        this._y += this._screenOffset.y
      }
      targetX = this._x
      targetY = this._y
      const left = this._x - widthMax * 0.5
      const right = this._x + widthMax * 0.5
      const top = this._y - heightMax
      const bottom = this._y

      if(widthMax &gt; this._bindedCanvas._canvasWidth - this._margin * 2){
        // size over
        // FIXME
      }else if(left &lt; this._margin){
        // too left
        this._x += this._margin - left
      }else if(right &gt; this._bindedCanvas._canvasWidth - this._margin){
        // too right
        this._x -= right - this._bindedCanvas._canvasWidth + this._margin
      }

      if(heightMax &gt; this._bindedCanvas._canvasHeight - this._margin * 2){
        // size over
        // FIXME
      }else if(top &lt; this._margin){
        // too high
        this._y += this._margin - top
      }else if(bottom &gt; this._bindedCanvas._canvasHeight - this._margin){
        // too low
        this._y -= bottom - this._bindedCanvas._canvasHeight + this._margin
      }
    }

    if(this._mode === this.MODE_OPEN){
      if(this._time &gt;= 1.0){
        this._time = 0.0
        this._mode = this.MODE_STRING
        height = heightMax
        width = widthMax
      }else{
        height = heightMax * this._time
        width = widthMax * this._time
      }
      // FIXME
      this.drawBalloon(targetX, targetY + vHeight, this._x - width * 0.5, this._y - height, width, height)
    }else if(this._mode === this.MODE_STRING){
      let textLen = 0

      if(this._time &gt;= 1.0){
        this._time = 0.0
        this._mode = this.MODE_STAY
        textLen = this._messageNumChars
      }else{
        textLen = Math.ceil(this._messageNumChars * this._time)
      }
      // FIXME
      this.drawBalloon(targetX, targetY + vHeight, this._x - widthMax * 0.5, this._y - heightMax, widthMax, heightMax)

      this._drawIconAndText(textLen)
    }else if(this._mode === this.MODE_STAY){
      // FIXME
      this.drawBalloon(targetX, targetY + vHeight, this._x - widthMax * 0.5, this._y - heightMax, widthMax, heightMax)

      this._drawIconAndText()
    }else if(this._mode === this.MODE_CLOSE){
      if(this._time &gt;= 1.0){
        this._time = 0.0
        this._mode = this.MODE_READY
      }else{
        height = heightMax * (1.0 - this._time)
        width = widthMax * (1.0 - this._time)
        // FIXME
        this.drawBalloon(targetX, targetY + vHeight, this._x - width * 0.5, this._y - height, width, height)
      }
    }
  }

  /**
   * draw icon image and text
   * @access private
   * @param {int} len - length of text (for animation)
   * @returns {void}
   */
  _drawIconAndText(len) {
    const c = this._bindedCanvas._2DContext

    let drawLen = this._messageNumChars
    if(0 &lt; len &amp;&amp; len &lt; drawLen){
      drawLen = len
    }

    const widthMax = this._messageWidth + this._padding * 2
    const heightMax = this._messageHeight + this._padding * 2
    const textLeft = this._x - widthMax * 0.5 + this._padding
    const textTop = this._y - heightMax + this._padding
    let iconLeft = 0
    let iconTop = 0
    let iconLines = 0
    let iconTextLeft = textLeft
    const iconPadding = this._iconPadding

    // drawIcon
    if(this._icon){
      iconTop  = textTop
      iconLeft = textLeft
      iconLines = Math.ceil((this._icon.height + iconPadding) / this._lineHeight)
      iconTextLeft += this._icon.width + iconPadding

      c.drawImage(this._icon, iconLeft, iconTop)
    }

    // drawText
    this.setupTextContext()
    let numChars = 0
    let line = 0
    let top = this._y - this._messageHeight - this._padding
    while(numChars &lt; drawLen){
      let str = this._formattedMessage[line]
      let strLen = str.length
      if(strLen + numChars &gt; drawLen){
        strLen = drawLen - numChars
        str = str.substr(0, strLen)
      }

      let left = textLeft
      if(line &lt; iconLines){
        left = iconTextLeft
      }

      //c.strokeText(str, left, top)
      c.fillText(str, left, top)

      numChars += strLen
      top += this._lineHeight
      line++
    }
  }

  /**
   * set up text context
   * @access public
   * @returns {void}
   */
  setupTextContext() {
    const c = this._bindedCanvas._2DContext

    c.font          = this._font
    c.fillStyle     = this._textColor
    c.textAlign     = this._textAlign
    c.textBaseline  = this._textBaseline

    c.shadowBlur    = this._textShadowBlur
    c.shadowColor   = this._textShadowColor
    c.shadowOffsetX = this._textShadowOffsetX
    c.shadowOffsetY = this._textShadowOffsetY
  }

  /**
   * set up balloon context
   * @access public
   * @returns {void}
   */
  setupBalloonContext() {
    const c = this._bindedCanvas._2DContext

    c.fillStyle     = this._backgroundColor
    c.strokeStyle   = this._borderColor

    c.globalAlpha   = this._globalAlpha
    c.globalCompositeOperation
                    = this._globalCompositeOperation

    c.lineCap       = this._lineCap
    c.lineJoin      = this._lineJoin
    c.lineWidth     = this._lineWidth

    c.shadowBlur    = this._balloonShadowBlur
    c.shadowColor   = this._balloonShadowColor
    c.shadowOffsetX = this._balloonShadowOffsetX
    c.shadowOffsetY = this._balloonShadowOffsetY
  }

  /**
   * draw balloon to given position
   * @access public
   * @param {float} speakerX -
   * @param {float} speakerY -
   * @param {float} left -
   * @param {float} top -
   * @param {float} width -
   * @param {float} height -
   * @returns {void}
   */
  drawBalloon(speakerX, speakerY, left, top, width, height) {
    const c = this._bindedCanvas._2DContext
    const vWidth = 5
    const bottom = top  + height
    const right  = left + width
    let vLeft  = speakerX - vWidth
    let vRight = speakerX + vWidth
    const p      = this._padding
    const w      = this._padding * 0.67

    const vLeftLimit  = p + this._margin
    const vRightLimit = this._bindedCanvas._canvasWidth - p - this._margin
    if(vLeft &lt; vLeftLimit){
      vLeft = vLeftLimit
      vRight = vLeft + vWidth * 2
    }else if(vRight &gt; vRightLimit){
      vRight = vRightLimit
      vLeft = vRight - vWidth * 2
    }

    // set balloon context
    this.setupBalloonContext()

    c.beginPath()

    c.moveTo(speakerX, speakerY)
    c.lineTo(vLeft, bottom)
    c.lineTo(left + p, bottom)
    c.bezierCurveTo(left + w, bottom,
                    left, bottom - w,
                    left, bottom - p)
    c.lineTo(left, top + p)
    c.bezierCurveTo(left, top + w,
                    left + w, top,
                    left + p, top)
    c.lineTo(right - p, top)
    c.bezierCurveTo(right - w, top,
                    right, top + w,
                    right, top + p)
    c.lineTo(right, bottom - p)
    c.bezierCurveTo(right, bottom - w,
                    right - w, bottom,
                    right - p, bottom)
    c.lineTo(vRight, bottom)
    c.lineTo(speakerX, speakerY)

    c.closePath()

    c.fill()
    c.stroke()
  }

  /**
   * open message window (start animation)
   * @access public
   * @returns {void}
   */
  open() {
    this._updateMessageSize()
    this._mode = this.MODE_OPEN
    this._time = 0.0
  }

  /**
   * close message window (start animation)
   * @access public
   * @returns {void}
   */
  close() {
    this._mode = this.MODE_CLOSE
    this._time = 0.0
  }

  /**
   * get context
   * @access public
   * @returns {CanvasRenderingContext2D}
   */
  getContext() {
    return this._bindedCanvas._2DContext
  }

  /**
   * set context
   * @access public
   * @param {CanvasRenderingContext2D} context - 
   * @returns {void}
   */
  setContext(context) {
    // duplicated
    //this._bindedContext = context
  }

  /**
   * get Canvas object
   * @access public
   * @returns {HTMLCanvasElement}
   */
  getCanvas() {
    return this._bindedCanvas
  }

  /**
   * set Canvas object
   * @access public
   * @param {HTMLCanvasElement} canvas - canvas object
   * @returns {void}
   */
  setCanvas(canvas) {
    this._bindedCanvas = canvas
    this._updateMessageSize()
  }

  /**
   * get icon image
   * @access public
   * @returns {HTMLImageElement}
   */
  getIcon() {
    return this._icon
  }

  /**
   * set icon image
   * @access public
   * @param {HTMLImageElement}
   * @returns {void}
   */
  setIcon(icon) {
    this._icon = icon
    this._updateMessageSize()
  }

  /**
   * get position offset
   * @access public
   * @returns {Vector3}
   */
  getOffset() {
    return this._offset
  }

  /**
   * set position offset
   * @access public
   * @param {float} x - X value
   * @param {float} y - Y value
   * @param {float} z - Z value
   * @returns {void}
   */
  setOffset(x, y, z) {
    if(x instanceof Vector3){
      this._offset = x
    }else{
      this._offset = new Vector3(x, y, z)
    }
  }

  /**
   * get screen offset
   * @access public
   * @returns {Vector3}
   */
  getScreenOffset() {
    return this._screenOffset
  }

  /**
   * set screen offset
   * @access public
   * @param {float} x - X value
   * @param {float} y - Y value
   * @param {float} z - Z value
   * @returns {void}
   */
  setScreenOffset(x, y, z) {
    if(x instanceof Vector3){
      this._screenOffset = x
    }else{
      this._screenOffset = new Vector3(x, y, z)
    }
  }

  /**
   * get message text
   * @access public
   * @returns {string} - message text
   */
  getMessage() {
    return this._message
  }

  /**
   * set message text
   * @access public
   * @param {string} message - text to show
   * @returns {void}
   */
  setMessage(message = null) {
    this._message = message
    this._updateMessageSize()
  }

  /**
   * get max width
   * @access public
   * @returns {int}
   */
  getMaxWidth() {
    return this._maxWidth
  }

  /**
   * set max width
   * @access public
   * @param {int} maxWidth -
   * @returns {void}
   */
  setMaxWidth(maxWidth) {
    this._maxWidth = maxWidth
    this._updateMessageSize()
  }

  /**
   * update message size
   * @access private
   * @returns {void}
   */
  _updateMessageSize() {
    let iconWidth = 0
    let iconHeight = 0

    if(this._icon){
      iconWidth  = this._icon.width  + this._iconPadding
      iconHeight = this._icon.height + this._iconPadding
    }
    if(this._message === null){
      this._messageNumChars = 0
      this._messageWidth  = iconWidth
      this._messageHeight = iconHeight
      return
    }
    
    const mArr = this._message.split(&apos;\n&apos;)
    this._formattedMessage = []
    const iconLines = Math.ceil(iconHeight / this._lineHeight)

    let maxLineWidth = this._maxWidth - this._padding * 2
    if(this._maxWidth &lt; 0){
      maxLineWidth = 65535
    }

    let strMaxWidth = 0
    let maxWidth = 0
    let messageNumChars = 0
    let line = 0
    const obj = this
    mArr.forEach( (str) =&gt; {
      let lineStr = str
      while(lineStr.length &gt; 0){
        if(line &lt; iconLines){
          maxWidth = maxLineWidth - iconWidth
        }else{
          maxWidth = maxLineWidth
        }
        const numChars = obj._getLineChars(lineStr, maxWidth)
        const chars = lineStr.substr(0, numChars)
        let charsWidth = obj._bindedCanvas._2DContext.measureText(chars).width
        if(line &lt; iconLines){
          charsWidth += iconWidth
        }
        if(charsWidth &gt; strMaxWidth){
          strMaxWidth = charsWidth
        }
        obj._formattedMessage.push(chars)
        lineStr = lineStr.substr(numChars)

        messageNumChars += numChars
        line++
      }
    })
    this._messageNumChars = messageNumChars
    this._messageWidth = strMaxWidth
    this._messageHeight = line * this._lineHeight
    if(this._messageHeight &lt; iconHeight){
      this._messageHeight = iconHeight
    }
  }

  /**
   * get text for one line
   * @access private
   * @param {string} str -
   * @param {int} maxWidth -
   */
  _getLineChars(str, maxWidth) {
    const c = this._bindedCanvas._2DContext
    const met = c.measureText(str)
    const strlen = str.length
    const strWidth = met.width
    if(strWidth &lt; maxWidth){
      return strlen
    }

    let minLen = 0
    let maxLen = strlen
    let newLen = strlen &gt;&gt; 1
    let newMet = null
    while(minLen &lt; maxLen - 1){
      newMet = c.measureText(str.substr(0, newLen))
      if(newMet.width &lt; maxWidth){
        minLen = newLen
        newLen = (newLen + maxLen) &gt;&gt; 1
      }else{
        maxLen = newLen
        newLen = (newLen + minLen) &gt;&gt; 1
      }
    }
    if(newMet.width &gt; maxWidth){
      return newLen - 1
    }

    return newLen
  }

  /**
   * get state of message window
   * @access public
   * @returns {int} - 0: ready, 1: opening, 2: show string, 3: waiting, 4: closing
   */
  getState() {
    return this._mode
  }
}

MessageWindow.prototype.MODE_READY  = 0
MessageWindow.prototype.MODE_OPEN   = 1
MessageWindow.prototype.MODE_STRING = 2
MessageWindow.prototype.MODE_STAY   = 3
MessageWindow.prototype.MODE_CLOSE  = 4
</code></pre>

</div>

<footer class="footer">
  Generated by <a href="https://esdoc.org">ESDoc<span data-ice="esdocVersion">(0.4.7)</span></a>
</footer>

<script src="script/search_index.js"></script>
<script src="script/search.js"></script>
<script src="script/pretty-print.js"></script>
<script src="script/inherited-summary.js"></script>
<script src="script/test-summary.js"></script>
<script src="script/inner-link.js"></script>
<script src="script/patch-for-local.js"></script>
</body>
</html>
